<?php
/**
 * @file
 * Code for the ICT Update feature.
 */

/**
 * @file
 * Code for the ICT VIZ feature.
 */

/**
 * Implements hook_ctools_plugin_directory().
 */
function ict_viz_ctools_plugin_directory($owner, $plugin_type) {
  if ($owner == 'ctools' && in_array($plugin_type, array('content_types', 'access'))) {
    return 'plugins/' . $plugin_type;
  }
}

/**
 * Implements hook_theme().
 */
function ict_viz_theme($existing, $type, $theme, $path) {
  return array(
    'ict_viz_home_projects' => array(
      'template' => 'ict-viz-home-projects',
      'path' => drupal_get_path('module', 'ict_viz') . '/theme',
    ),
    'ict_viz_number_indicators' => array(
      'path' => drupal_get_path('module', 'ict_viz') . '/theme',
      'template' => 'ict-viz-number-indicators',
    ),
  );
}

function template_preprocess_ict_viz_home_projects(&$vars) {
  $query = db_select('node', 'project');

  // check if Project have at least one approved Update
  $query->distinct();
  $query->join('field_data_field_project', 'update_node', 'project.nid = update_node.field_project_target_id');
  $query->join('field_data_field_expenditure_budget_calc', 'budget', 'project.nid = budget.entity_id');
  $query->join('field_data_field_expenditure_to_date_calc', 'to_date', 'project.nid = to_date.entity_id');
  $query->join('field_data_field_number_of_benefits_calc', 'benefits', 'project.nid = benefits.entity_id');
  $query->join('field_data_field_schedule_status_calc', 'status', 'project.nid = status.entity_id');
  $query->join('project_workflow', 'workflow', 'update_node.entity_id = workflow.nid');
  $query->fields('project');
  $query->addField('budget', 'field_expenditure_budget_calc_value');
  $query->addField('to_date', 'field_expenditure_to_date_calc_value');
  $query->addField('benefits', 'field_number_of_benefits_calc_value');
  $query->addField('status', 'field_schedule_status_calc_value');
  $query->condition('workflow.state', 'approved');
  $query->condition('project.type', 'project');

  $results = $query->execute()->fetchAll();
}
